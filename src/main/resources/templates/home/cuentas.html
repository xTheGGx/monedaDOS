<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es" class="light">
<head th:replace="~{fragments/layout :: headFrag('Cuentas')}"></head>
<th:block th:fragment="pageCss">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</th:block>
<body>
<div class="page-wrapper">
    <div th:replace="~{fragments/layout :: navbar('cuentas')}"></div>
    <main class="container main-content">
        <div class="main-headline">
            <div>
                <h1>Gestión de Cuentas</h1>
                <p class="subtitle">Aquí están todas tus cuentas, ¡bien organizadas!</p>
            </div>
            <div class="totals">
                <span class="kpi-label">Saldo total</span>
                <strong th:text="${#numbers.formatDecimal(saldoTotal,1,'COMMA',2,'POINT')}"></strong>
            </div>
        </div>

        <div class="accounts-grid">
            <div class="card account-card" th:each="c : ${cuentas}">
                <div class="account-card-header">
                    <h3 th:text="${c.nombre}">Nombre Cuenta</h3>
                    <span class="badge-faint"
                          th:classappend="${c.tipo.name()=='CREDITO'} ? ' badge-faint-red' : ' badge-faint-green'"
                          th:text="${c.tipo}">DEBITO</span>
                </div>

                <p class="account-bank" th:text="${c.moneda}">MXN</p>

                <p class="account-balance"
                   th:classappend="${c.saldo < 0} ? ' text-expense' : ''"
                   th:text="${#numbers.formatDecimal(c.saldo,1,'COMMA',2,'POINT')}">
                    $0.00
                </p>

                <div class="account-credit-details" th:if="${c.tipo.name()=='CREDITO'}">
                    <small>
                        Corte: <span th:text="${c.diaCorte != null ? c.diaCorte : '-'}">-</span> ·
                        Pago: <span th:text="${c.diaPago  != null ? c.diaPago  : '-'}">-</span>
                        <span th:if="${c.limiteCredito != null}">
          · Límite: <span th:text="${#numbers.formatDecimal(c.limiteCredito,1,'COMMA',2,'POINT')}"></span>
        </span>
                    </small>
                </div>

                <div class="account-card-footer">
                    <a class="button-link" th:href="@{|/transacciones?cuenta=${c.idCuenta}|}">Ver movimientos</a>

                    <button class="button-primary-small" disabled>Editar</button>
                </div>
            </div>


            <div class="card account-card-add" id="btn-open-add-account">
                <span class="material-symbols-outlined">add_circle</span>
                <strong>Agregar Nueva Cuenta</strong>
                <p>Añade una cuenta de débito, crédito o de inversión.</p>
            </div>
        </div>
    </main>
    <div th:replace="~{fragments/layout :: footer}"></div>
</div>
<div class="sidebar-overlay" id="add-account-overlay"></div>
<aside class="sidebar-form" id="add-account-sidebar">
    <div class="sidebar-header">
        <h3>Añadir Cuenta</h3>
        <button class="sidebar-close" id="btn-close-add-account">&times;</button>
    </div>

    <form th:action="@{/cuentas}" method="post" th:object="${cuentaDTO}" class="stack">
        <!-- CSRF -->
        <input th:if="${_csrf != null}" type="hidden"
               th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <label>Nombre
            <input type="text" th:field="*{nombre}" placeholder="Mi Débito / Mi Visa" required maxlength="100"/>
        </label>

        <label>Tipo
            <select th:field="*{tipo}" required>
                <option th:each="t : ${tipos}" th:value="${t}" th:text="${t}"></option>
            </select>

        </label>

        <div class="grid-2" id="credit-fields">
            <label>Día de corte
                <input type="number" th:field="*{diaCorte}" min="1" max="31" placeholder="15"/>
            </label>
            <label>Día de pago
                <input type="number" th:field="*{diaPago}" min="1" max="31" placeholder="2"/>
            </label>
        </div>

        <label>Límite de crédito (opcional)
            <input type="number" step="0.01" th:field="*{limiteCredito}" placeholder="20000.00"/>
        </label>

        <button type="submit" class="button-primary">Guardar</button>

        <p class="form-msg success" th:if="${created}">¡Cuenta creada!</p>
        <p class="form-msg error" th:if="${error}" th:text="${error}"></p>
    </form>
</aside>
<script th:src="@{/js/scripts.js}" defer></script>
</body>
</html>
