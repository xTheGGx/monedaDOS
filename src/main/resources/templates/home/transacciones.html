<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es" class="light">
<head th:replace="~{fragments/layout :: headFrag('Transacciones')}"></head>
<body>
<div class="page-wrapper">
    <div th:replace="~{fragments/layout :: navbar('tx')}"></div>

    <main class="container main-content">
        <div class="main-headline" style="align-items: center;">
            <div>
                <h1>Transacciones</h1>
                <p class="subtitle">Consulta, filtra y registra todos tus movimientos.</p>
            </div>
            <button class="button-primary" id="btn-open-sidebar">
                <span class="material-symbols-outlined">add</span>
                Registrar Movimiento
            </button>
        </div>

        <!-- Filtros -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <h3 class="card-title">Filtros</h3>
            <form class="filter-form" th:action="@{/transacciones}" method="get">
                <div class="form-group">
                    <label for="filtro-mes">Mes</label>
                    <select id="filtro-mes" name="mes" class="form-select">
                        <option value="" th:selected="${selectedMes == ''}">Todos los meses</option>
                        <option th:each="mes : ${ultimosMeses}"
                                th:value="${mes[0]}"
                                th:text="${mes[1]}"
                                th:selected="${selectedMes == mes[0]}">
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filtro-tipo">Tipo</label>
                    <select id="filtro-tipo" name="tipo" class="form-select">
                        <option value="" th:selected="${selectedTipo == ''}">Todos</option>
                        <option value="INGRESO" th:selected="${selectedTipo == 'INGRESO'}">Ingreso</option>
                        <option value="EGRESO" th:selected="${selectedTipo == 'EGRESO'}">Gasto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filtro-cat">Categoría</label>
                    <select id="filtro-cat" name="categoria" class="form-select">
                        <option value="" th:selected="${selectedCategoria == ''}">Todas</option>
                        <!-- Agrupar categorías por tipo para claridad -->
                        <optgroup label="Ingresos"
                                  th:if="${categoriasIngreso != null and !#lists.isEmpty(categoriasIngreso)}">
                            <option th:each="cat : ${categoriasIngreso}"
                                    th:value="${cat.idCategoria}"
                                    th:text="${cat.nombre}"
                                    th:selected="${selectedCategoria == cat.idCategoria.toString()}">
                            </option>
                        </optgroup>
                        <optgroup label="Gastos" th:if="${categoriasGasto.size() > 0}">
                            <option th:each="cat : ${categoriasGasto}"
                                    th:value="${cat.idCategoria}"
                                    th:text="${cat.nombre}"
                                    th:selected="${selectedCategoria == cat.idCategoria.toString()}">
                            </option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filtro-cuenta">Cuenta</label>
                    <select id="filtro-cuenta" name="cuenta" class="form-select">
                        <option value="" th:selected="${selectedCuenta == ''}">Todas</option>
                        <option th:each="cta : ${cuentas}"
                                th:value="${cta.idCuenta}"
                                th:text="${cta.nombre}"
                                th:selected="${selectedCuenta == cta.idCuenta.toString()}">
                        </option>
                    </select>
                </div>
                <button class="button-secondary" type="submit">Filtrar</button>
            </form>
        </div>

        <!-- Lista de transacciones -->
        <div class="card transactions-card">
            <h3 class="card-title">Historial de Movimientos</h3>
            <div class="table-container">
                <table class="transactions-table">
                    <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Descripción</th>
                        <th class="col-desktop">Categoría</th>
                        <th class="col-desktop">Cuenta</th>
                        <th class="col-right">Monto</th>
                        <th class="col-actions"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="tx : ${transaccionesPage.content}">
                        <td class="text-muted" th:text="${#temporals.format(tx.fecha, 'dd MMM')}">--</td>
                        <td class="text-main" th:text="${tx.descripcion}">--</td>
                        <td class="col-desktop">
                            <!-- Badge de categoría con color -->
                            <span class="badge" th:text="${tx.categoria.nombre}"
                                  th:style="'background-color:' + ${tx.categoria.color} + '; color: #fff;'">
                                </span>
                        </td>
                        <td class="col-desktop text-muted" th:text="${tx.cuenta.nombre}">--</td>
                        <td class="col-right">
  <span th:text="${tx.monto}"
        th:classappend="${tx.monto < 0} ? ' text-expense' : ' text-income'"></span>
                        </td>

                        <td class="col-actions" style="text-align: center;">
                            <!-- Botón editar transacción -->
                            <button type="button" class="icon-btn edit-tx-btn"
                                    th:data-id="${tx.idTransaccion}"
                                    th:data-cuenta="${tx.cuenta.idCuenta}"
                                    th:data-categoria="${tx.categoria.idCategoria}"
                                    th:data-monto="${tx.monto}"
                                    th:data-descripcion="${tx.descripcion}"
                                    th:data-tipo="${tx.categoria.tipo.name()}">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <!-- Formulario eliminar transacción -->
                            <form th:action="@{/transacciones/eliminar/{id}(id=${tx.idTransaccion})}" method="post"
                                  style="display:inline;">
                                <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}"/>
                                <button type="submit" class="icon-btn delete-tx-btn">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${transaccionesPage.totalElements == 0}">
                        <td class="text-muted" colspan="6">No hay transacciones para mostrar.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- Paginación -->
            <div class="pagination" style="text-align: center; margin-top: 0.5rem;">
                <span th:if="${transaccionesPage.hasPrevious()}">
                    <a class="page-link"
                       th:href="@{/transacciones(page=${transaccionesPage.number - 1}, mes=${selectedMes}, tipo=${selectedTipo}, categoria=${selectedCategoria}, cuenta=${selectedCuenta})}">
                        « Anterior
                    </a>
                </span>
                <span> Página <span th:text="${transaccionesPage.number + 1}">1</span> de <span
                        th:text="${transaccionesPage.totalPages}">1</span> </span>
                <span th:if="${transaccionesPage.hasNext()}">
                    <a class="page-link"
                       th:href="@{/transacciones(page=${transaccionesPage.number + 1}, mes=${selectedMes}, tipo=${selectedTipo}, categoria=${selectedCategoria}, cuenta=${selectedCuenta})}">
                        Siguiente »
                    </a>
                </span>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/layout :: footer}"></div>
</div>

<!-- Overlay oscuro, activo condicionalmente si alguna sidebar está abierta -->
<div id="sidebar-overlay"
     class="sidebar-overlay"
     th:classappend="${created != null or error != null or catError != null} ? 'active' : ''">

</div>

<!-- Sidebar Registrar/Editar Movimiento -->
<aside class="sidebar-form"
       id="register-sidebar"
       th:classappend="${created != null or error != null or catError != null} ? 'active' : ''"
>
    <div class="sidebar-header">
        <h3 th:text="${transaccionDTO.idTransaccion != null}? 'Editar Movimiento' : 'Registrar Movimiento'">Registrar
            Movimiento</h3>
        <button class="sidebar-close" id="btn-close-sidebar">×</button>
    </div>

    <form class="sidebar-content" th:action="@{/transacciones}" th:object="${transaccionDTO}" method="post">
        <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <!-- Campo oculto para id de transacción (edición) -->
        <input type="hidden" id="txId" th:field="*{idTransaccion}"/>

        <input type="hidden" id="tipoMovimiento" name="tipoMovimiento" value="INGRESO"/>

        <div class="form-group">
            <label>Tipo de movimiento</label>
            <div class="tipo-movimiento">
                <button type="button" class="tipo-btn ingreso active" id="btn-ingreso">
                    <span class="material-symbols-outlined">add</span> Ingreso
                </button>
                <button type="button" class="tipo-btn gasto" id="btn-gasto">
                    <span class="material-symbols-outlined">remove</span> Gasto
                </button>
            </div>
        </div>

        <div class="form-group">
            <label for="sidebar-monto">Monto</label>
            <input type="number" step="0.01" th:field="*{monto}" class="form-input" placeholder="0.00" required/>
        </div>

        <div class="form-group">
            <label for="sidebar-desc">Descripción</label>
            <input type="text" th:field="*{descripcion}" class="form-input" placeholder="Ej: Café de la mañana"
                   maxlength="255"/>
        </div>

        <div class="form-group">
            <label for="sidebar-cat">Categoría
                <!-- Botón para abrir sidebar de categorías -->
                <button type="button" id="btn-edit-category" class="icon-btn" style="vertical-align: middle;"
                        title="Editar categorías">
                    <span class="material-symbols-outlined">edit</span>
                </button>
            </label>
            <select id="sidebar-cat" th:field="*{categoriaId}" class="form-select" required>
                <option value="" disabled th:selected="${transaccionDTO.categoriaId == null}">Selecciona una categoría
                </option>
                <option th:each="cat : ${categorias}"
                        th:value="${cat.idCategoria}"
                        th:text="${cat.nombre}"
                        th:data-tipo="${cat.tipo.name()}"
                        th:data-color="${cat.color}"
                        th:style="${cat.tipo.name() == 'EGRESO'} ? 'display:none;' : ''">
                </option>
                <option value="new">+ Nueva categoría...</option>
            </select>
        </div>

        <div class="form-group">
            <label for="sidebar-cuenta">Cuenta</label>
            <select id="sidebar-cuenta" th:field="*{cuentaId}" class="form-select" required>
                <option value="" disabled th:selected="${transaccionDTO.cuentaId == null}">Selecciona una cuenta
                </option>
                <option th:each="cta : ${cuentas}"
                        th:value="${cta.idCuenta}"
                        th:text="${cta.nombre}">
                </option>
            </select>
        </div>

        <!-- Mensajes de éxito/error del formulario de transacción -->
        <p class="form-msg success" th:if="${created}" th:text="${created}"></p>
        <p class="form-msg error" th:if="${error}" th:text="${error}"></p>

        <button class="button-primary" type="submit" style="width: 100%; justify-content: center; margin-top: auto;">
            Guardar Movimiento
        </button>
    </form>
</aside>

<!-- Sidebar Añadir/Editar Categoría -->
<aside class="sidebar-form" id="category-sidebar"
       th:classappend="${catError != null} ? ' active' : ''">

    <div class="sidebar-header">
        <h3 th:text="${categoriaDTO.nombre != null}? 'Editar Categoría' : 'Nueva Categoría'">Nueva Categoría</h3>
        <button class="sidebar-close" id="btn-close-category">×</button>
    </div>
    <form class="sidebar-content" th:if="${categoriaDTO != null}"
          th:action="${categoriaDTO.nombre != null && categoriaDTO.nombre != ''}? @{'/categorias/' + ${categoriaDTO.id}} : @{'/categorias'}"
          th:object="${categoriaDTO}" method="post">
        <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <!-- Campo Nombre -->
        <div class="form-group">
            <label for="cat-nombre">Nombre de categoría</label>
            <input type="text" th:field="*{nombre}" id="cat-nombre" class="form-input" placeholder="Ej: Salud"
                   maxlength="80" required/>
        </div>
        <!-- Campo Tipo de categoría (Ingreso/Egreso) -->
        <div class="form-group">
            <label>Tipo de categoría</label>
            <div class="tipo-movimiento">
                <button type="button" class="tipo-btn ingreso active" id="btn-cat-ingreso">
                    <span class="material-symbols-outlined">south_west</span> Ingreso
                </button>
                <button type="button" class="tipo-btn gasto" id="btn-cat-gasto">
                    <span class="material-symbols-outlined">north_east</span> Gasto
                </button>
            </div>
            <!-- Input oculto para tipo -->
            <input type="hidden" id="tipoCategoria" th:field="*{tipo}"/>
        </div>
        <!-- Campo Color -->
        <div class="form-group">
            <label for="cat-color">Color</label>
            <input type="color" th:field="*{color}" id="cat-color" class="form-input"
                   style="height: 2.5rem; padding: 0;"/>
        </div>
        <!-- (Opcional) Campo Clasificación (Necesiad/Deseo/Ahorro) - podría añadirse un select si se desea manejar -->
        <!-- Mensajes de error del formulario de categoría -->
        <p class="form-msg error" th:if="${catError}" th:text="${catError}"></p>
        <!-- Botones Guardar/Eliminar -->
        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: auto;">
            <button class="button-primary" type="submit" style="flex: 1;">Guardar Categoría</button>
            <button type="submit" name="delete" id="btn-delete-category" class="button-secondary"
                    style="margin-left: 0.5rem; background-color: #ff6b6b; color: #fff;">
                Eliminar
            </button>
        </div>
    </form>
</aside>

<!-- Archivos JavaScript -->
<script th:src="@{/js/scripts.js}"></script>
</body>
</html>
